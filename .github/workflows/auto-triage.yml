name: Auto Triage

on:
  issues:
    types: [opened, reopened]
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  ensure-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure standard labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: 'needs-triage', color: 'BFD4F2', description: 'New issue awaiting triage' },
              { name: 'needs-review', color: 'D4C5F9', description: 'PR awaiting reviewer attention' },
              { name: 'size:XS', color: 'C2E0C6', description: 'PR under 50 changed lines' },
              { name: 'size:S', color: '7FD39B', description: 'PR under 200 changed lines' },
              { name: 'size:M', color: 'F9D0C4', description: 'PR under 500 changed lines' },
              { name: 'size:L', color: 'F9C2C2', description: 'PR under 1000 changed lines' },
              { name: 'size:XL', color: 'E99695', description: 'PR 1000+ changed lines' },
              { name: 'area:commands', color: '1D76DB', description: 'Command surface changes' },
              { name: 'area:adapter', color: '0052CC', description: 'Adapter/integration changes' },
              { name: 'area:tests', color: '5319E7', description: 'Test-related changes' },
              { name: 'area:ci', color: '0E8A16', description: 'CI/CD or automation changes' },
              { name: 'area:docs', color: '0075CA', description: 'Documentation changes' },
              { name: 'area:config', color: 'FBCA04', description: 'Configuration/runtime changes' },
            ];

            const { owner, repo } = context.repo;
            const existing = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner,
              repo,
              per_page: 100,
            });
            const existingByName = new Map(existing.map((l) => [l.name, l]));

            for (const label of labels) {
              if (existingByName.has(label.name)) {
                await github.rest.issues.updateLabel({
                  owner,
                  repo,
                  name: label.name,
                  color: label.color,
                  description: label.description,
                });
              } else {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label.name,
                  color: label.color,
                  description: label.description,
                });
              }
            }

  issue-triage:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    needs: ensure-labels
    steps:
      - name: Label new issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number: context.payload.issue.number,
              labels: ['needs-triage'],
            });

  pr-labeler:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    needs: ensure-labels
    steps:
      - name: Apply path-based labels
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  pr-triage:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    needs: ensure-labels
    steps:
      - name: Add review and size labels
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const total = (pr.additions || 0) + (pr.deletions || 0);
            let size = 'size:XL';
            if (total < 50) size = 'size:XS';
            else if (total < 200) size = 'size:S';
            else if (total < 500) size = 'size:M';
            else if (total < 1000) size = 'size:L';

            const sizeLabels = ['size:XS', 'size:S', 'size:M', 'size:L', 'size:XL'];
            const issue_number = pr.number;

            const current = await github.rest.issues.listLabelsOnIssue({
              ...context.repo,
              issue_number,
            });

            for (const label of current.data.map((l) => l.name)) {
              if (sizeLabels.includes(label) && label !== size) {
                await github.rest.issues.removeLabel({
                  ...context.repo,
                  issue_number,
                  name: label,
                });
              }
            }

            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number,
              labels: ['needs-review', size],
            });
